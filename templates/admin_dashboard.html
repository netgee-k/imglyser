<!-- templates/admin_dashboard.html -->
{% extends "base.html" %}

{% block title %}Admin Dashboard - imglyser Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="bi bi-shield-check"></i> imglyser Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/analyze"><i class="bi bi-upload"></i> Upload Image</a></li>
                            <li><a class="dropdown-item" href="/api/user/analyses"><i class="bi bi-history"></i> My Analyses</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <div class="p-3">
                <h5><i class="bi bi-menu-button-wide"></i> Navigation</h5>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="/admin">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/analyze">
                        <i class="bi bi-upload"></i> Analyze Image
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api/admin/users">
                        <i class="bi bi-people"></i> Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api/admin/analyses">
                        <i class="bi bi-file-earmark-text"></i> Analyses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api/admin/stats">
                        <i class="bi bi-graph-up"></i> Statistics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api/admin/audit">
                        <i class="bi bi-clipboard-data"></i> Audit Log
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 p-4">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stat-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Users</h6>
                                    <h2>{{ stats.total_users }}</h2>
                                </div>
                                <i class="bi bi-people-fill display-6"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Analyses</h6>
                                    <h2>{{ stats.total_analyses }}</h2>
                                </div>
                                <i class="bi bi-file-earmark-text-fill display-6"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Recent Analyses</h6>
                                    <h2>{{ stats.recent_analyses }}</h2>
                                </div>
                                <i class="bi bi-clock-history display-6"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Active Users</h6>
                                    <h2>{{ stats.active_users }}</h2>
                                </div>
                                <i class="bi bi-person-check-fill display-6"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-activity"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for action in recent_actions %}
                                <tr>
                                    <td>{{ action.timestamp }}</td>
                                    <td>{{ action.user_id if action.user_id else 'System' }}</td>
                                    <td><span class="badge bg-secondary">{{ action.action }}</span></td>
                                    <td>{{ action.details[:50] }}...</td>
                                    <td><code>{{ action.ip_address }}</code></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/analyze" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> Analyze New Image
                                </a>
                                <button class="btn btn-outline-success" onclick="exportData()">
                                    <i class="bi bi-download"></i> Export Data
                                </button>
                                <button class="btn btn-outline-info" onclick="refreshStats()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Stats
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-exclamation-triangle"></i> System Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="spinner-grow text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="mb-0">System: <span class="text-success">Operational</span></h6>
                                    <small class="text-muted">All systems functioning normally</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('user');
    window.location.href = '/login';
}

function exportData() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    fetch('/api/export/csv', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        // Create download link
        const blob = new Blob([data.data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
}

function refreshStats() {
    location.reload();
}

// Check authentication on page load
window.addEventListener('load', function() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
    }
});
</script>
{% endblock %}
